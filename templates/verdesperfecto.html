{% extends "layout.html" %}

{% block title %}
    Desperfectos
{% endblock %}

{% block main %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">


  
  
  <section class="p-4 my-container">
    
    <div class="navbar1">
        <div class="left-content">
            <button  type="submit" class="btn prueba btn-primary mb-4" id="menu-btn">
                <i class="fas fa-bars"></i> Menú
            </button>
        </div>
        <a href="/logout"> 
                <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
        </a>  
        {% if session["user_id"][0][1] == 'admin' %}
  
        <a href="/edituser"> Usuarios </a>
        {% endif %}
  
      </div>  
    <!-- Button trigger modal -->


<!-- Modal -->
<div class="modal fade " id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Selecciona un producto</h5>
        <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <ul class="tres" style="list-style: none;">
            <li>
              <div class="form-group">
              <input type="text" class="form-control" id="searchInput1" onkeyup="filterDropdown()" placeholder="Buscar..." >
              </div>
            </li>
              {% if productos %}
              {% for row in productos %}
              <li onclick="obtenerDatos('{{row.CodigoProducto}}')"   data-mdb-target="#exampleModalToggle22" data-mdb-toggle="modal" data-mdb-dismiss="modal">
                  <div class="card mb-3 nombreMarca" style="max-width: 540px;" id="{{row.CodigoProducto}}" >
                      <div class="row g-0">
                          <div class="col-md-4 foto">
                              <img src="{{row.foto}}" class="img-fluid rounded-start" alt="...">
                          </div>
                          <div class="col-md-8">
                              <div class="card-body">
                                <h5 class="card-title"> Codigo : {{row.CodigoProducto}}</h5>
                                  <p class="card-text"> Nombre : {{row.NombreProducto}}   </p>
                                  <p class="card-texts"> Pares : {{row.stock}}</p>

                              </div>
                          </div>
                      </div>
                  </div>
              </li>
              {% endfor %}

              {% else %}
              <h5 class="text-center">Sin productos</h5>


              {% endif %}

          </ul>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
         
<!-- Add desperfecto segundo modal -->
<form action="/adddesperfecto" , method="post">

<div class="modal fade" id="exampleModalToggle22" aria-hidden="true" aria-labelledby="exampleModalToggleLabel22" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 >Rellene los campos </h5>
          <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
                <!-- Elemento donde se mostrarán los datos -->
                <div id="datosSeleccionadosList">
                </div>

            <div class="container">
              <div class="row">
                  <div class="col-6">
                      <label class="form-label" for="fecha">fecha de salida *:
                        <input class="form-input" type="date" name="fecha"  min="2023-01-01" id="add_fecha"   required onblur="fecha2()">
                        <p id="messagefecha" style="color: red;"> </p>

                      </label>
                  </div>
                  <div class="col-6">
                      <label class="form-label" for="cantidad">Cantidad *:
                        <input type="number" class="form-control" name="cantidad" placeholder="#" min="1" id="cantidad" required>
                       </label>
                  </div>
                  <label for="exampleFormControlTextarea1" class="form-label">Descripcion *:
                    <textarea    class="form-control" rows="3" name="descripcion"  id="descripcion" required></textarea>
                  </label>
              </div>
            </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-mdb-target="#exampleModal" data-mdb-toggle="modal">
            Back to first
          </button>
          <button type="submit" class="btn btn-primary">
            Registra Desperfecto
        </button>
          
        </div>
      </div>
    </div>
  </div>
</form>

    <div class="form-group text-center">
        <input type="text" id="searchDespr" class="form-control mx-auto custom-border" onkeyup="filter()" placeholder="Buscar...">
        <button type="button" class="btn btn-primary" data-mdb-toggle="modal" data-mdb-target="#exampleModal">
            Registra Desperfecto
        </button>

    </div>
    <!-- tabla para mostrar desperfectos-->
    <table class="table table-dark table-striped">
    <thead>
        <tr>
            <th scope="col">Nombre del Producto</th>
            <th scope="col" class="text-break">Descripcion</th>
            <th scope="col">Fecha de Salida</th>
            <th scope="col">Cantidad de Salida</th>
            <th scope="col"></th>

        </tr>
        </thead>
        <tbody class="tres">
        {% for row in datos %}
        <tr>
            <td class="NombrePro">{{row.NombreProducto }}</td>
            <td class="Descrip">{{row.Descripcion}}</td>
            <td class="FechaSalida">{{row.FechaSalida}}</td>
            <td class="Cantidadsalida">{{row.Cantidadsalida}}</td>
            <td> 
               <a href="#" class="btn btn-primary btn-sm editar-empleado"  data-producto="{{row.p}}" data-CodigoSP="{{row.CodigoSP}}" data-NombreProducto="{{row.NombreProducto}}" data-Descripcion="{{row.Descripcion}}" data-FechaSalida="{{row.FechaSalida}}" data-Cantidadsalida="{{row.Cantidadsalida}}" ><i class="fas fa-pencil"></i></a>
                {% if session["user_id"][0][1] == 'admin' %}
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-light btn-sm  eliminar-empleado" data-CODIGOpc="{{row.CodigoSP}}" data-mdb-toggle="modal" data-mdb-target="#selecciondelete"><i class="fa fa-trash"></i>
                </button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
            <!-- Modal  
            <div class="modal fade " id="selecciondelete" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Selecciona </h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body text-center">
                    <h5>Popover in a modal</h5>
                    <p>
                     <button>perdida total</button>
                    </p>
                    <hr />

                    <h5>Tooltips in a modal</h5>
                      <button> producto recuperado </button>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
              -->

    <!-- Ventana modal -->
    <form action="/editardesperfecto" method="post"  enctype="multipart/form-data">
        <div id="editarModal" class="modal fade " tabindex="-1" role="dialog" aria-labelledby="editarModalLabel" aria-hidden="true">
            <div class="modal-dialog ">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editarModalLabel">Editar Desperfecto</h5>
                        <button type="button" class="close ocultar" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">
                        <input type="hidden" id="producto" name="productoid">
                        <input type="hidden" id="CodigoSP" name="CodigoSP">

                        <div class="form-group">
                            <label for="NombreEmpleado">Nombre</label>
                            <input type="text" class="form-control" id="NombreProducto" name="nombre" required disabled>
                        </div>
                        <div class="container">
                          <div class="row">
                            <div class="col-6">
                              <label for="Dirreccion">FechaSalida
                                <input type="date" class="form-control" id="FechaSalida" name="FechaSalida" required onblur="fecha()">
                                <input type="hidden" name="" id="hiddenfecha" >
                                <p id="message_fecha" style="color: red;"> </p>
                              </label>
                            </div>
                            <div class="col-6">
                              <label for="Dirreccion">Cantidadsalida
                                <input type="number" class="form-control" id="Cantidadsalida" name="Cantidadsalida" min="1" required >
                              </label>
                            </div>
                            <label for="Correo">Descripcion 
                              <textarea type="text"  rows="5" style="resize: none;" class="form-control" id="Descripcion" name="Descripcion" required></textarea>
                            </label>
                          </div>
                        </div>                       
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary guardar-cambios">Guardar</button>
                        <button type="button"  class="btn btn-secondary ocultar" data-dismiss="modal">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
    
    <form action="/eliminardesperfecto" method="post" id="deleteForm">
        <input type="hidden" id="ideli" name="idhiddenform">    
        <input type="hidden" name="tabla" >
    </form>
</section>

  
<script src="/static/js/navbar.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script src="static/js/mdb/mdb/mdb.min.js"></script>

<!--js propio-->
<script>
    $(document).ready(function() {
    
    $('.editar-empleado').click(function() {
        var producto = $(this).data('producto');
        var CodigoSP = $(this).data('codigosp');
        var NombreProducto = $(this).data('nombreproducto');
        var Descripcion = $(this).data('descripcion');
        var FechaSalida = $(this).data('fechasalida'); 
        var Cantidadsalida = $(this).data('cantidadsalida');

      
         // Llenar los campos de la ventana modal con los datos del empleado
        $('#producto').val(producto);
        $('#CodigoSP').val(CodigoSP);
        $('#NombreProducto').val(NombreProducto);
        $('#Descripcion').val(Descripcion);
        $('#FechaSalida').val(FechaSalida);
        $('#hiddenfecha').val(FechaSalida);
        $('#Cantidadsalida').val(Cantidadsalida);


      // Mostrar la ventana modal
      $('#editarModal').modal('show');
    });

    $('.ocultar').click(function() {
        $('#editarModal').modal('hide');
      });
    
});

function filter() {
    var input, filter, tbody, td, i;
    input = document.getElementById("searchDespr");
    filter = input.value.toUpperCase();
    tbody = document.querySelector(".table");
    td = tbody.getElementsByTagName("tr");

    for (i = 1; i < td.length; i++) { // Comenzamos desde 1 para omitir el primer elemento (campo de búsqueda)
        var nombre = td[i].querySelector(".NombrePro");
        var descrip = td[i].querySelector(".Descrip");
        var fechaSalida = td[i].querySelector(".FechaSalida");
        var cantidadSalida = td[i].querySelector(".Cantidadsalida");

        var searchText = nombre.innerText + " " + descrip.innerText + " " + fechaSalida.innerText + " " + cantidadSalida.innerText;
        if (searchText.toUpperCase().indexOf(filter) > -1) {
            td[i].style.display = "";
        } else {
            td[i].style.display = "none";
        }
    }
}


$(document).ready(function() {

  var error_add_desperfecto = "{{ error_add_desperfecto }}";
    
// Verifica si hay un mensaje de error y muestra la modal correspondiente
if (error_add_desperfecto == 'Error') {
  Swal.fire({
    position: 'center',
    icon: 'warning',
    title:'Error al añadir desperfecto',
    showConfirmButton: false,
    timer: 2000
  })
}



var add_desperfecto = "{{ add_desperfecto }}";
    
// Verifica si hay un mensaje de error y muestra la modal correspondiente
if (add_desperfecto == 'add_desperfecto') {
  Swal.fire({
    position: 'center',
    icon: 'success',
    title:add_desperfecto,
    showConfirmButton: false,
    timer: 2000
  })
}

var correct_desperfecto = "{{ correct_desperfecto }}";
    
// Verifica si hay un mensaje de error y muestra la modal correspondiente
if (correct_desperfecto == 'Eliminado!') {
  Swal.fire({
    position: 'center',
    icon: 'success',
    title:correct_desperfecto,
    showConfirmButton: false,
    timer: 2000
  })
}

        
        $('.eliminar-empleado').click(function() {
        var CodigoSP = $(this).data('codigopc');
        console.log(CodigoSP)
        Swal.fire({
        title: '¿Estás seguro?',
        text: '¿Deseas eliminar el registro?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
        
      }).then((result) => {
       
        if (result.isConfirmed) {
            $('#ideli').val(CodigoSP);
            document.getElementById("deleteForm").submit();
    
        } else {
          console.log("Eliminación cancelada");
        }
        });
    
        });
            
    });

</script>
<script src="/static/js/addesperfecto.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

{% endblock %}